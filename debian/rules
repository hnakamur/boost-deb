#! /usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

export DH_OPTIONS

include /usr/share/quilt/quilt.make

# set the number of build jobs
#JOBS = -j2

DEB_BUILD_ARCH ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH)

# Boost does not guarantee any ABI, it uses the full version in SONAME
SOVERSION = 1.34.1
SHLIBS_VERSION = (>= 1.34.1-8)
DEBIAN_SUFFIX =

# tags for library name decoration
boost_version = $(subst .,_,$(SOVERSION))
gcc_version = gcc42

# Boost libraries for which we want separate packages
boost_libs := date-time filesystem graph iostreams program-options python regex serialization signals test thread wave

# these are special cases, where shared library has not the same name of the Boost library
boost_lib_serialization := serialization wserialization
boost_lib_test := prg_exec_monitor unit_test_framework

# these are special cases for variants. normal cases have <empty>, -d, -mt, -mt-d variants
boost_variants_thread := -mt -mt-d

# These are special cases for suffixes.  Generally come from --buildid, so begin with a dash.
boost_suffixes_python := -py24 -py25

# Function to map Boost component name to set of shared library names
# Input: Boost component name
# Return: shared library names for the given Boost library
boost_lib = $(if $(boost_lib_$(1)), $(boost_lib_$(1)), $(1))

# Function to map Boost component name to set of variants for the library
# Input: Boost component name
# Return: variants for the given Boost component
boost_variants = $(if $(boost_variants_$(1)), $(boost_variants_$(1)), -st -st-d -mt -mt-d)

# Function to map Boost component name to set of suffixes for the library
# Input: Boost component name
# Return: suffixes for the given Boost component
boost_suffixes = $(if $(boost_suffixes_$(1)), $(boost_suffixes_$(1)),"")

# Helpers to make basic and decorated library names
# Input: library, variant, suffix
# Return: base library filename for short, full, or gcc41-compatibility name
mk_base_name = usr/lib/libboost_$(subst -,_,$(1))$(2)$(3)
mk_full_name = usr/lib/libboost_$(subst -,_,$(1))-$(gcc_version)$(2)-$(boost_version)$(3)
mk_compat_name = usr/lib/libboost_$(subst -,_,$(1))-gcc41$(2)-$(boost_version)$(3)

# Input: component, variant
# Return: package name for shared library or development
mk_pkg_lib = libboost-$(if $(findstring -d,$(2)),dbg,$(1)$(SOVERSION)$(DEBIAN_SUFFIX))
mk_pkg_dev = libboost-$(if $(findstring -d,$(2)),dbg,$(1)-dev)

# Helpers to generate debhelper input filenames.
# Input: component, variant
# Return: prefix to debhelper filenames
mk_deb_lib = debian/$(call mk_pkg_lib,$(1),$(2))
mk_deb_dev = debian/$(call mk_pkg_dev,$(1),$(2))
mk_ove_lib = $(call mk_deb_lib,$(1),$(2))/usr/share/lintian/overrides/$(call mk_pkg_lib,$(1),$(2))

# Helpers that update debhelper .install or .links files
# Input: component, library, variant, suffix
# Output: none
mk_a_files = $(shell echo debian/tmp/$(call mk_full_name,$(2),$(3),$(4)).a >> $(call mk_deb_dev,$(1),$(3)).install)
mk_so_files = $(shell echo debian/tmp/$(call mk_full_name,$(2),$(3),$(4)).so.$(SOVERSION) >> $(call mk_deb_lib,$(1),$(3)).install)
mk_ln_files = $(shell echo $(call mk_full_name,$(2),$(3),$(4)).so.$(SOVERSION) $(call mk_full_name,$(2),$(3),$(4)).so >> $(call mk_deb_dev,$(1),$(3)).links)
mk_ln2_files = $(shell echo $(call mk_full_name,$(2),$(3),$(4)).so $(call mk_base_name,$(2),$(3),$(4)).so >> $(call mk_deb_dev,$(1),$(3)).links)
mk_ln3_files = $(shell echo $(call mk_full_name,$(2),$(3),$(4)).a $(call mk_base_name,$(2),$(3),$(4)).a >> $(call mk_deb_dev,$(1),$(3)).links)
mk_ln4_files = $(shell echo $(call mk_full_name,$(2),$(3),$(4)).so.$(SOVERSION) $(call mk_compat_name,$(2),$(3),$(4)).so.$(SOVERSION) >> $(call mk_deb_lib,$(1),$(3)).links)

# Link shared lib with suffix2 to suffix1
# Input: component, library, variant, suffix1, suffix2
mk_ln_suffices = $(shell echo $(call mk_full_name,$(2),$(3),$(4)).so.$(SOVERSION) $(call mk_full_name,$(2),$(3),$(5)).so.$(SOVERSION) >> $(call mk_deb_lib,$(1),$(3)).links)
mk_ln_suffices_compat = $(shell echo $(call mk_full_name,$(2),$(3),$(4)).so.$(SOVERSION) $(call mk_compat_name,$(2),$(3),$(5)).so.$(SOVERSION) >> $(call mk_deb_lib,$(1),$(3)).links)

# Function that updates debhelper files for a given library variant
# Input: component, library, variant, suffix
# Output: none
mk_files = $(foreach fn,a so ln ln2 ln3 ln4,$(call mk_$(fn)_files,$(1),$(2),$(3),$(4)))

# helpers to make and install lintian override files
mk_override_files = echo $(call mk_pkg_lib,$(1)): package-name-doesnt-match-sonames >> $(call mk_ove_lib,$(1));
ins_lintian_overrides = install -m644 debian/$(1).lintian-overrides debian/$(1)/usr/share/lintian/overrides/$(1);

# Function that updates debhelper files for all library variants shipped.
mk_debhelper_files = \
	$(foreach l, $(boost_libs), \
		echo "making debhelper files for $(l)..."; \
		$(call mk_override_files,$(l)) \
		$(foreach ll, $(call boost_lib,$(l)), \
			$(foreach v, $(call boost_variants,$(l)), \
				$(foreach suf, $(call boost_suffixes,$(l)), \
					$(call mk_files,$(l),$(ll),$(subst -st,,$(v)),$(suf)) \
				) \
			) \
		) \
	)

# Add to debhelper links files to create compatibility links for 
# Boost.Python
mk_python_debhelper_files = \
	$(foreach ll, $(call boost_lib,python), \
		$(foreach v, $(call boost_variants,python), \
			echo "Links for python$(subst -st,,$(v))"; \
			$(call mk_ln_suffices,python,$(ll),$(subst -st,,$(v)),-py24,) \
		) \
	)


TOOLSET_CONFIG="using gcc : 4.2 : g++-4.2 : <define>_REENTRANT ;"
ifeq ($(DEB_BUILD_ARCH), hppa)
TOOLSET_CONFIG="using gcc : 4.2 : g++-4.2 : <define>_REENTRANT <compileflags>-mlong-calls ;"
endif
PYTHON_CONFIG1 = "using python : 2.4 : /usr ;"
PYTHON_CONFIG2 = "using python : 2.5 : /usr ;"

exampledir = debian/libboost-doc/usr/share/doc/libboost-doc/examples
htmldir = debian/libboost-doc/usr/share/doc/libboost-doc/HTML
pyste_prefix = $(CURDIR)/debian/pyste/usr
bjam = $(CURDIR)/tools/jam/src/bjam

JAM = $(bjam) $(JOBS) -d2 --user-config=$(CURDIR)/user-config.jam -sHAVE_ICU=1

$(bjam):
	cd tools/jam/src && CFLAGS=-fno-strict-aliasing sh build.sh cc && mv bin.*/bjam .

build: build-stamp
build-stamp: $(QUILT_STAMPFN) $(bjam)
	dh_testdir

	echo $(TOOLSET_CONFIG) > user-config.jam
	echo $(PYTHON_CONFIG1) >> user-config.jam
	echo $(PYTHON_CONFIG2) >> user-config.jam

	cd tools/bcp && $(JAM)
	cd tools/inspect/build && $(JAM)
	cd tools/wave/build && $(JAM)
	cd tools/regression/build && $(JAM)

	$(JAM) --without-python             variant=release,debug threading=single,multi
	$(JAM) --with-python --buildid=py24 variant=release,debug threading=single,multi python=2.4
	$(JAM) --with-python --buildid=py25 variant=release,debug threading=single,multi python=2.5
	cd libs/python/pyste/install && python setup.py build

	touch build-stamp

clean-debhelper:
	rm -rf debian/libboost-*$(SOVERSION)$(DEBIAN_SUFFIX).lintian-overrides
	rm -rf debian/libboost-*$(SOVERSION)$(DEBIAN_SUFFIX).install
	rm -rf debian/libboost-*-dev.install
	rm -rf debian/libboost-*-dev.links
	rm -rf debian/libboost-*$(SOVERSION).links
	rm -rf debian/libboost-dbg.install
	rm -rf debian/libboost-dbg.links

clean: unpatch clean-debhelper
	dh_testdir
	dh_testroot
	rm -f build-stamp

	-cd tools && $(JAM) clean
	-$(JAM) clean
	cd libs/python/pyste/install && python setup.py clean

	rm -rf libs/python/pyste/install/build
	rm -rf tools/jam/src/bootstrap
	rm -rf tools/jam/src/bin.*
	rm -ff tools/jam/src/bjam
	rm -rf bin.v2 dist
	rm -rf user-config.jam

	dh_clean build-stamp

install: DH_OPTIONS=-X.svn
install: build clean-debhelper
	dh_testdir
	dh_testroot
	dh_clean -k

	$(JAM) --prefix=$(CURDIR)/debian/tmp/usr install
	install --mode=755 -D debian/rtupdate debian/tmp/usr/share/python/runtime.d/libboost-python-dev.rtupdate
	install --mode=755 -D debian/rtupdate debian/tmp/usr/share/python/runtime.d/libboost-dbg.rtupdate

	# Remove undecorated Boost.Python libraries and install decorated ones
	rm debian/tmp/usr/lib/lib*python*
	find bin.v2/libs/python -name libboost_python*-py2* | xargs install -t debian/tmp/usr/lib

	find debian/tmp/usr/include -type f | xargs chmod 644
	find debian/tmp -name .cvsignore | xargs rm -f
	find debian -empty -type f | xargs rm -f

	dh_installdirs -A usr/share/lintian/overrides

	# generate (some) debhelper files
	@$(call mk_debhelper_files)
	@$(call mk_python_debhelper_files)

	# package pyste
	cd libs/python/pyste/install && python setup.py install --no-compile --prefix=$(pyste_prefix) --install-lib=$(pyste_prefix)/share/python-support/pyste
	mv $(pyste_prefix)/bin/pyste.py $(pyste_prefix)/bin/pyste
	dh_installman -ppyste debian/pyste.1

	# package bcp
	dh_installdirs -pbcp usr/bin
	dh_install -pbcp dist/bin/bcp usr/bin
	dh_installman -pbcp debian/bcp.1

	# package libboost-dbg
	dh_install -plibboost-dbg
	dh_install -plibboost-dbg --autodest \
	   debian/tmp/usr/share/python/runtime.d/libboost-dbg.rtupdate
	dh_link -plibboost-dbg \
	   usr/lib/libboost_thread-mt-d.a usr/lib/libboost_thread-d.a \
	   usr/lib/libboost_thread-mt-d.so usr/lib/libboost_thread-d.so
	$(call ins_lintian_overrides,libboost-dbg)

	# package libboost-dev
	dh_install -plibboost-dev \
	   debian/tmp/usr/include/boost-$(boost_version)/boost \
	   usr/include
	$(call ins_lintian_overrides,libboost-dev)

	# package libboost-doc
	rm -rf $(htmldir)
	mkdir -p $(htmldir) $(htmldir)/more/css_0
	cp more/css_0/* $(htmldir)/more/css_0
	cat debian/documentation-files | xargs cp --parents --target-directory=$(htmldir)
	find doc libs -name doc | xargs -n1 cp --archive --target-directory=$(htmldir)
	rm -rf $(htmldir)/boost
	dh_link -plibboost-doc \
	   usr/include/boost \
	   usr/share/doc/libboost-doc/HTML/boost

	mkdir -p $(exampledir)
	cat debian/example-files | xargs cp -a --parents --target-directory=$(exampledir)
	find $(exampledir) -type f | xargs chmod 644
	$(call ins_lintian_overrides,libboost-doc)


	# package libboost-date-time$(SOVERSION)
	dh_install -plibboost-date-time$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-date-time-dev
	dh_installdirs -plibboost-date-time-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/date_time* \
	   debian/libboost-date-time-dev/usr/include/boost
	dh_install -plibboost-date-time-dev
	dh_link -plibboost-date-time-dev

	# package libboost-filesystem$(SOVERSION)
	dh_install -plibboost-filesystem$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-filesystem-dev
	dh_installdirs -plibboost-filesystem-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/filesystem* \
	   debian/libboost-filesystem-dev/usr/include/boost
	dh_install -plibboost-filesystem-dev
	dh_link -plibboost-filesystem-dev

	# package libboost-graph$(SOVERSION)
	dh_install -plibboost-graph$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-graph-dev
	dh_installdirs -plibboost-graph-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/graph \
	   debian/libboost-graph-dev/usr/include/boost
	dh_install -plibboost-graph-dev
	dh_link -plibboost-graph-dev

	# package libboost-iostreams$(SOVERSION)
	dh_install -plibboost-iostreams$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-iostreams-dev
	dh_installdirs -plibboost-iostreams-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/iostreams* \
	   debian/libboost-iostreams-dev/usr/include/boost
	dh_install -plibboost-iostreams-dev
	dh_link -plibboost-iostreams-dev

	# package libboost-program-options$(SOVERSION)
	dh_install -plibboost-program-options$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-program-options-dev
	dh_installdirs -plibboost-program-options-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/program_options* \
	   debian/libboost-program-options-dev/usr/include/boost
	dh_install -plibboost-program-options-dev
	dh_link -plibboost-program-options-dev

	# package libboost-python$(SOVERSION)
	dh_install -plibboost-python$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-python-dev
	dh_installdirs -plibboost-python-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/python* \
	   debian/libboost-python-dev/usr/include/boost
	dh_install -plibboost-python-dev --autodest \
	   debian/tmp/usr/share/python/runtime.d/libboost-python-dev.rtupdate
	dh_link -plibboost-python-dev
	$(call ins_lintian_overrides,libboost-python-dev)

	# package libboost-regex$(SOVERSION)
	dh_install -plibboost-regex$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-regex-dev
	dh_installdirs -plibboost-regex-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/*regex* \
	   debian/libboost-regex-dev/usr/include/boost
	dh_install -plibboost-regex-dev
	dh_link -plibboost-regex-dev

	# package libboost-serialization$(SOVERSION)
	dh_install -plibboost-serialization$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-serialization-dev
	dh_installdirs -plibboost-serialization-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/*serialization* \
	   debian/libboost-serialization-dev/usr/include/boost
	dh_install -plibboost-serialization-dev
	dh_link -plibboost-serialization-dev

	# package libboost-signals$(SOVERSION)
	dh_install -plibboost-signals$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-signals-dev
	dh_installdirs -plibboost-signals-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/*signal* \
	   debian/libboost-signals-dev/usr/include/boost
	dh_install -plibboost-signals-dev
	dh_link -plibboost-signals-dev

	# package libboost-test$(SOVERSION)
	dh_install -plibboost-test$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-test-dev
	dh_installdirs -plibboost-test-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/test \
	   debian/libboost-test-dev/usr/include/boost
	dh_install -plibboost-test-dev
	dh_link -plibboost-test-dev

	# package libboost-thread$(SOVERSION)
	dh_install -plibboost-thread$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-thread-dev
	dh_installdirs -plibboost-thread-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/thread* \
	   debian/libboost-thread-dev/usr/include/boost
	dh_install -plibboost-thread-dev
	dh_link -plibboost-thread-dev \
	   usr/lib/libboost_thread-mt.a usr/lib/libboost_thread.a \
	   usr/lib/libboost_thread-mt.so usr/lib/libboost_thread.so

	# package libboost-wave$(SOVERSION)
	dh_install -plibboost-wave$(SOVERSION)$(DEBIAN_SUFFIX)
	# package libboost-wave-dev
	dh_installdirs -plibboost-wave-dev usr/include/boost
	mv debian/libboost-dev/usr/include/boost/wave* \
	   debian/libboost-wave-dev/usr/include/boost
	dh_install -plibboost-wave-dev
	dh_link -plibboost-wave-dev

# This single target is used to build all the packages, all at once, or
# one at a time. So keep in mind: any options passed to commands here will
# affect _all_ packages. Anything you want to only affect one package
# should be put in another target, such as the install target.
binary-common:
	dh_testdir
	dh_testroot
	dh_installdocs --all debian/README.Debian
	dh_installexamples
	dh_installinfo
	dh_installchangelogs
	dh_strip -Nlibboost-dbg
	dh_link
	dh_compress -Xlibboost-doc/HTML
	dh_pysupport
	dh_fixperms

	@if [ "$(DH_OPTIONS)" = "-a" ]; then \
		echo DH_OPTIONS=-plibboost-dbg dh_makeshlibs -V"libboost-dbg $(SHLIBS_VERSION)"; \
		DH_OPTIONS=-plibboost-dbg dh_makeshlibs -V"libboost-dbg $(SHLIBS_VERSION)"; \
		for name in date-time filesystem graph iostreams program-options python regex serialization signals test thread wave; do \
			lib=libboost-$${name}$(SOVERSION)$(DEBIAN_SUFFIX); \
			echo DH_OPTIONS=-p$${lib} dh_makeshlibs -V"$${lib} $(SHLIBS_VERSION)"; \
			DH_OPTIONS=-p$${lib} dh_makeshlibs -V"$${lib} $(SHLIBS_VERSION)"; \
		done; \
		DH_OPTIONS=-plibboost-dbg dh_makeshlibs -V"libboost-dbg $(SHLIBS_VERSION)"; \
	fi

	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture independant packages using the common target.
binary-indep: build install
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

# Build architecture dependant packages using the common target.
binary-arch: build install
	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

# Any other binary targets build just one binary package at a time.
binary-%: build install
	$(MAKE) -f debian/rules binary-common DH_OPTIONS=-p$*

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary-common binary install
