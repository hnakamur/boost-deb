#! /usr/bin/make -f

include /usr/share/quilt/quilt.make

export DH_OPTIONS

# set the number of build jobs
ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	JOBS := -j$(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
endif

DEB_BUILD_ARCH ?= $(shell dpkg-architecture -qDEB_BUILD_ARCH)

PKGVERSION = 1.40
SOVERSION = 1.40.0
SHLIBS_VERSION = (>= 1.40.0-1)

# Boost libraries for which we want separate packages
boost_libs := date-time filesystem graph-parallel graph iostreams math mpi	       \
	program-options python regex serialization signals system test \
	thread wave

# these are special cases, where shared library has not the same name of the Boost library
boost_lib_math := math_c99 math_c99f math_tr1 math_tr1f
boost_lib_math_long_double := math_c99l math_tr1l
#TODO: boost_lib_mpi := mpi mpi_python
boost_lib_serialization := serialization wserialization
boost_lib_test := prg_exec_monitor unit_test_framework

# These are special cases for suffixes.  Generally come from --buildid, so begin with a dash.
boost_suffixes_python := -py24 -py25

# Files that are generated by filtering a template
filtered_files = \
	debian/libboost-doc.doc-base \
	debian/libboost-python-dev.postinst \
	debian/libboost-python-dev.prerm

# Function to map Boost component name to set of shared library names
# Input: Boost component name
# Return: shared library names for the given Boost library
boost_lib = $(if $(boost_lib_$(1)), $(boost_lib_$(1)), $(1))

# Function to map Boost component name to set of suffixes for the library
# Input: Boost component name
# Return: suffixes for the given Boost component
boost_suffixes = $(if $(boost_suffixes_$(1)), $(boost_suffixes_$(1)),"")

# Helpers to make basic and decorated library names
# Input: library, variant, suffix
# Return: base library filename for short or full name
mk_base_name = usr/lib/libboost_$(subst -,_,$(1))$(2)$(3)

# Input: component, variant
# Return: package name for shared library or development
mk_pkg_lib = libboost$(if $(findstring -d,$(2)),$(PKGVERSION)-dbg,-$(1)$(SOVERSION))
mk_pkg_dev = libboost$(if $(findstring -d,$(2)),$(PKGVERSION)-dbg,-$(1)$(PKGVERSION)-dev)

# Helpers to generate debhelper input filenames.
# Input: component, variant
# Return: prefix to debhelper filenames
mk_deb_lib = debian/$(call mk_pkg_lib,$(1),$(2))
mk_deb_dev = debian/$(call mk_pkg_dev,$(1),$(2))

# Helpers that update debhelper .install or .links files
# Input: component, library, variant, suffix
# Output: none
mk_so_files = $(shell echo debian/tmp/$(call mk_base_name,$(2),$(3),$(4)).so.$(SOVERSION) >> $(call mk_deb_lib,$(1),$(3)).install)
mk_a_files = $(shell echo debian/tmp/$(call mk_base_name,$(2),$(3),$(4)).a >> $(call mk_deb_dev,$(1),$(3)).install)
mk_ln_files = $(shell echo $(call mk_base_name,$(2),$(3),$(4)).so.$(SOVERSION) $(call mk_base_name,$(2),$(3),$(4)).so >> $(call mk_deb_dev,$(1),$(3)).links)

# Make compatibility symlinks libfoo-mt --> libfoo
mk_mtso_files = $(shell echo $(call mk_base_name,$(2),$(3),$(4)).so.$(SOVERSION) $(call mk_base_name,$(2),$(3)-mt,$(4)).so >> $(call mk_deb_dev,$(1),$(3)).links)
mk_mta_files = $(shell echo $(call mk_base_name,$(2),$(3),$(4)).a $(call mk_base_name,$(2),$(3)-mt,$(4)).a >> $(call mk_deb_dev,$(1),$(3)).links)

# Function that updates debhelper files for a given library variant
# Input: component, library, variant, suffix
# Output: none
mk_files = $(foreach fn,a so ln mtso mta,$(call mk_$(fn)_files,$(1),$(2),$(3),$(4)))

# helpers to make and install lintian override files

# Input: package, override
add_override = echo $(1): $(2) >> debian/$(1).lintian-overrides;

# Input: override
add_dbg_override = $(call add_override,libboost$(PKGVERSION)-dbg,$(1))
add_dev_override = $(call add_override,libboost$(PKGVERSION)-dev,$(1))
add_doc_override = $(call add_override,libboost$(PKGVERSION)-doc,$(1))

# Input: component, variant, lintian-warning
add_lib_override = $(call add_override,$(call mk_pkg_lib,$(1),$(2)),$(3))
add_libdev_override = $(call add_override,$(call mk_pkg_dev,$(1),$(2)),$(3))

cp_debhelper = for s in doc-base examples postinst prerm README.Debian; do \
	if test -f debian/$(1).$$s; then cp -f debian/$(1).$$s debian/$(2).$$s; fi; done

# Function that updates debhelper files for all library variants shipped.
mk_debhelper_files = \
	$(call add_dbg_override,package-name-doesnt-match-sonames) \
	$(call add_dbg_override,non-dev-pkg-with-shlib-symlink) \
	$(call add_dbg_override,dbg-package-missing-depends) \
	$(call add_dev_override,description-synopsis-starts-with-a-capital-letter) \
	$(call add_dev_override,spelling-error-in-description) \
	$(call add_dev_override,extra-license-file) \
	$(call add_doc_override,description-synopsis-starts-with-a-capital-letter) \
	$(call add_doc_override,extra-license-file) \
	$(call add_libdev_override,python,,description-synopsis-starts-with-a-capital-letter) \
	$(foreach l, $(boost_libs), \
		echo "making debhelper files for $(l)..."; \
		$(call add_lib_override,$(l),,package-name-doesnt-match-sonames) \
		$(foreach ll, $(call boost_lib,$(l)), \
			$(foreach suf, $(call boost_suffixes,$(l)), \
				$(call mk_files,$(l),$(ll),,$(suf)) \
			) \
		) \
	)

TOOLSET_CONFIG="using gcc : : : <compileflags>-D_REENTRANT ;"
BUILD_LONG_DOUBLE = yes

ifeq ($(DEB_BUILD_ARCH), hppa)
TOOLSET_CONFIG="using gcc : : : <compileflags>-D_REENTRANT <compileflags>-mlong-calls <compileflags>-DBOOST_SP_USE_PTHREADS ;"
BUILD_LONG_DOUBLE = no
else ifeq ($(DEB_BUILD_ARCH), arm)
BUILD_LONG_DOUBLE = no
else ifeq ($(DEB_BUILD_ARCH), armel)
BUILD_LONG_DOUBLE = no
else ifeq ($(DEB_BUILD_ARCH), mips)
BUILD_LONG_DOUBLE = no
else ifeq ($(DEB_BUILD_ARCH), mipsel)
BUILD_LONG_DOUBLE = no
else ifeq ($(DEB_BUILD_ARCH), sh4)
BUILD_LONG_DOUBLE = no
endif

ifeq ($(BUILD_LONG_DOUBLE), yes)
boost_lib_math += $(boost_lib_math_long_double)
else
JAM_OPT += --disable-long-double
endif

MPI_CONFIG = "using mpi ;"
PYTHON_CONFIG1 = "using python : 2.4 : /usr ;"

exampledir = debian/libboost$(PKGVERSION)-doc/usr/share/doc/libboost$(PKGVERSION)-doc/examples
htmldir = debian/libboost$(PKGVERSION)-doc/usr/share/doc/libboost$(PKGVERSION)-doc/HTML
pyste_prefix = $(CURDIR)/debian/libboost-python$(PKGVERSION)-dev/usr
bjam = $(CURDIR)/bjam

# FIXME: find a flag to disable reading /etc/site-config.jam
JAM = $(bjam) $(JOBS) -d2 $(JAM_OPT) --layout=system --user-config=$(CURDIR)/user-config.jam debug-symbols=on

$(bjam): $(QUILT_STAMPFN)
	./bootstrap.sh --with-icu --prefix=$(CURDIR)/debian/tmp/usr

user-config.jam:
	echo $(TOOLSET_CONFIG) > $@
	echo $(MPI_CONFIG)     >> $@
	echo $(PYTHON_CONFIG1) >> $@

build: build-stamp
build-stamp: $(QUILT_STAMPFN) $(bjam) user-config.jam
	dh_testdir

	$(JAM) --without-python                        
	$(JAM) --with-python --buildid=py24 python=2.4 
	$(JAM) --with-python --buildid=py25 python=2.5 

	cd tools/bcp && $(JAM)
	cd tools/inspect/build && $(JAM)
	cd tools/quickbook && $(JAM)
	cd tools/wave/build && $(JAM)
	cd tools/regression/build && $(JAM)
	cd libs/python/pyste/install && python setup.py build

	touch build-stamp

$(filtered_files): % : %.in
	sed -e 's/@PKGVERSION@/$(PKGVERSION)/g' < $< > $@

clean-debhelper:
	rm -rf debian/*.install
	rm -rf debian/*.links
	rm -rf debian/*.lintian-overrides

clean: unpatch clean-debhelper
	dh_testdir
	dh_testroot
	rm -f build-stamp

	-cd tools && $(JAM) clean
	-$(JAM) clean
	-cd libs/python/pyste/install && python setup.py clean

	rm -rf libs/python/pyste/install/build
	rm -rf tools/jam/src/bootstrap
	rm -rf tools/jam/src/bin.*
	rm -ff tools/jam/src/bjam
	rm -rf tools/regression/build/bin
	rm -rf bin.v2 dist
	rm -rf user-config.jam

	dh_clean build-stamp

# This rule is for debugging debian/rules.
make-debhelper: clean-debhelper
	@$(call mk_debhelper_files)

install: DH_OPTIONS=-X.svn
install: build clean-debhelper $(filtered_files)
	dh_testdir
	dh_testroot
	dh_prep

	@$(call cp_debhelper,libboost-dbg,libboost$(PKGVERSION)-dbg)
	@$(call cp_debhelper,libboost-dev,libboost$(PKGVERSION)-dev)
	@$(call cp_debhelper,libboost-doc,libboost$(PKGVERSION)-doc)
	@$(call cp_debhelper,libboost-python-dev,libboost-python$(PKGVERSION)-dev)

	$(JAM) --prefix=$(CURDIR)/debian/tmp/usr install --without-python                        
	$(JAM) --prefix=$(CURDIR)/debian/tmp/usr install --with-python --buildid=py24 python=2.4 
	$(JAM) --prefix=$(CURDIR)/debian/tmp/usr install --with-python --buildid=py25 python=2.5 

	install --mode=755 -D debian/rtupdate debian/tmp/usr/share/python/runtime.d/libboost-python$(PKGVERSION)-dev.rtupdate

	find debian/tmp/usr/include -type f | xargs chmod 644
	find debian/tmp -name .cvsignore | xargs rm -f
	find debian -empty -type f | xargs rm -f

	# generate (some) debhelper files
	@$(call mk_debhelper_files)

	# package libboost-dbg
	dh_install -plibboost$(PKGVERSION)-dbg

	# package libboost$(PKGVERSION)-dev
	dh_install -plibboost$(PKGVERSION)-dev \
	   debian/tmp/usr/include/boost \
	   usr/include
	dh_install -plibboost$(PKGVERSION)-dev \
	   dist/bin/bcp \
	   dist/bin/inspect \
	   dist/bin/quickbook \
	   usr/bin
	dh_installman -plibboost$(PKGVERSION)-dev debian/bcp.1 debian/inspect.1 debian/quickbook.1
	dh_install -plibboost$(PKGVERSION)-dev tools/boostbook/xsl/* usr/share/boostbook/xsl
	dh_install -plibboost$(PKGVERSION)-dev tools/boostbook/dtd/* usr/share/boostbook/dtd

	# package libboost-doc
	rm -rf $(htmldir)
	mkdir -p $(htmldir) 
	cat debian/documentation-files | xargs cp --parents --target-directory=$(htmldir)
	find doc libs -name doc | xargs -n1 cp --archive --target-directory=$(htmldir)
	rm $(htmldir)/doc/html/images/callouts/Thumbs.db
	rm -rf $(htmldir)/boost
	dh_link -plibboost$(PKGVERSION)-doc \
	   usr/include/boost \
	   usr/share/doc/libboost$(PKGVERSION)-doc/HTML/boost

	mkdir -p $(exampledir)
	cat debian/example-files | xargs cp -a --parents --target-directory=$(exampledir)
	find $(exampledir) -type f | xargs chmod 644


	# package libboost-date-time$(SOVERSION)
	dh_install -plibboost-date-time$(SOVERSION)
	# package libboost-date-time$(PKGVERSION)-dev
	dh_installdirs -plibboost-date-time$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/date_time* \
	   debian/libboost-date-time$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-date-time$(PKGVERSION)-dev
	dh_link -plibboost-date-time$(PKGVERSION)-dev

	# package libboost-filesystem$(SOVERSION)
	dh_install -plibboost-filesystem$(SOVERSION)
	# package libboost-filesystem$(PKGVERSION)-dev
	dh_installdirs -plibboost-filesystem$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/filesystem* \
	   debian/libboost-filesystem$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-filesystem$(PKGVERSION)-dev
	dh_link -plibboost-filesystem$(PKGVERSION)-dev

# Includes for graph-parallel are a subdirectory of graph so we have
# to move the former before moving the include/boost/graph files.
	# package libboost-graph-parallel$(SOVERSION)
	dh_install -plibboost-graph-parallel$(SOVERSION)
	# package libboost-graph-parallel$(PKGVERSION)-dev
	dh_installdirs -plibboost-graph-parallel$(PKGVERSION)-dev usr/include/boost/graph
	# Move distributed & parallel
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/graph/distributed \
	   debian/libboost-graph-parallel$(PKGVERSION)-dev/usr/include/boost/graph
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/graph/parallel \
	   debian/libboost-graph-parallel$(PKGVERSION)-dev/usr/include/boost/graph
	dh_install -plibboost-graph-parallel$(PKGVERSION)-dev
	dh_link -plibboost-graph-parallel$(PKGVERSION)-dev

	# package libboost-graph$(SOVERSION)
	dh_install -plibboost-graph$(SOVERSION)
	# package libboost-graph$(PKGVERSION)-dev
	dh_installdirs -plibboost-graph$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/graph \
	   debian/libboost-graph$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-graph$(PKGVERSION)-dev
	dh_link -plibboost-graph$(PKGVERSION)-dev

	# package libboost-iostreams$(SOVERSION)
	dh_install -plibboost-iostreams$(SOVERSION)
	# package libboost-iostreams$(PKGVERSION)-dev
	dh_installdirs -plibboost-iostreams$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/iostreams* \
	   debian/libboost-iostreams$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-iostreams$(PKGVERSION)-dev
	dh_link -plibboost-iostreams$(PKGVERSION)-dev

	# package libboost-math$(SOVERSION)
	dh_install -plibboost-math$(SOVERSION)
	# package libboost-math$(PKGVERSION)-dev
	dh_installdirs -plibboost-math$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/math* \
	   debian/libboost-math$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-math$(PKGVERSION)-dev
	dh_link -plibboost-math$(PKGVERSION)-dev

	# package libboost-mpi$(SOVERSION)
	dh_install -plibboost-mpi$(SOVERSION)
	# package libboost-mpi$(PKGVERSION)-dev
	dh_installdirs -plibboost-mpi$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/mpi* \
	   debian/libboost-mpi$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-mpi$(PKGVERSION)-dev
	dh_link -plibboost-mpi$(PKGVERSION)-dev

	# package libboost-program-options$(SOVERSION)
	dh_install -plibboost-program-options$(SOVERSION)
	# package libboost-program-options$(PKGVERSION)-dev
	dh_installdirs -plibboost-program-options$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/program_options* \
	   debian/libboost-program-options$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-program-options$(PKGVERSION)-dev
	dh_link -plibboost-program-options$(PKGVERSION)-dev

	# package libboost-python$(SOVERSION)
	dh_install -plibboost-python$(SOVERSION)
	# package libboost-python$(PKGVERSION)-dev
	dh_installdirs -plibboost-python$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/python* \
	   debian/libboost-python$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-python$(PKGVERSION)-dev --autodest \
	   debian/tmp/usr/share/python/runtime.d/libboost-python$(PKGVERSION)-dev.rtupdate
	dh_link -plibboost-python$(PKGVERSION)-dev

	cd libs/python/pyste/install && python setup.py install --no-compile --prefix=$(pyste_prefix) --install-lib=$(pyste_prefix)/share/python-support/pyste
	mv $(pyste_prefix)/bin/pyste.py $(pyste_prefix)/bin/pyste
	dh_installman -plibboost-python$(PKGVERSION)-dev debian/pyste.1

	# package libboost-regex$(SOVERSION)
	dh_install -plibboost-regex$(SOVERSION)
	# package libboost-regex$(PKGVERSION)-dev
	dh_installdirs -plibboost-regex$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/*regex* \
	   debian/libboost-regex$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-regex$(PKGVERSION)-dev
	dh_link -plibboost-regex$(PKGVERSION)-dev

	# package libboost-serialization$(SOVERSION)
	dh_install -plibboost-serialization$(SOVERSION)
	# package libboost-serialization$(PKGVERSION)-dev
	dh_installdirs -plibboost-serialization$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/*serialization* \
	   debian/libboost-serialization$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-serialization$(PKGVERSION)-dev
	dh_link -plibboost-serialization$(PKGVERSION)-dev

	# package libboost-signals$(SOVERSION)
	dh_install -plibboost-signals$(SOVERSION)
	# package libboost-signals$(PKGVERSION)-dev
	dh_installdirs -plibboost-signals$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/*signal* \
	   debian/libboost-signals$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-signals$(PKGVERSION)-dev
	dh_link -plibboost-signals$(PKGVERSION)-dev

	# package libboost-system$(SOVERSION)
	dh_install -plibboost-system$(SOVERSION)
	# package libboost-system$(PKGVERSION)-dev
	dh_installdirs -plibboost-system$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/system \
	   debian/libboost-system$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-system$(PKGVERSION)-dev
	dh_link -plibboost-system$(PKGVERSION)-dev

	# package libboost-test$(SOVERSION)
	dh_install -plibboost-test$(SOVERSION)
	# package libboost-test$(PKGVERSION)-dev
	dh_installdirs -plibboost-test$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/test \
	   debian/libboost-test$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-test$(PKGVERSION)-dev
	dh_link -plibboost-test$(PKGVERSION)-dev

	# package libboost-thread$(SOVERSION)
	dh_install -plibboost-thread$(SOVERSION)
	# package libboost-thread$(PKGVERSION)-dev
	dh_installdirs -plibboost-thread$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/thread* \
	   debian/libboost-thread$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-thread$(PKGVERSION)-dev

	# package libboost-wave$(SOVERSION)
	dh_install -plibboost-wave$(SOVERSION)
	# package libboost-wave$(PKGVERSION)-dev
	dh_installdirs -plibboost-wave$(PKGVERSION)-dev usr/include/boost
	mv debian/libboost$(PKGVERSION)-dev/usr/include/boost/wave* \
	   debian/libboost-wave$(PKGVERSION)-dev/usr/include/boost
	dh_install -plibboost-wave$(PKGVERSION)-dev
	dh_link -plibboost-wave$(PKGVERSION)-dev

# This single target is used to build all the packages, all at once, or
# one at a time. So keep in mind: any options passed to commands here will
# affect _all_ packages. Anything you want to only affect one package
# should be put in another target, such as the install target.
binary-common:
	dh_testdir
	dh_testroot
	dh_installdocs --all debian/README.Debian debian/NEWS.Debian
	dh_installexamples
	dh_installinfo
	dh_installchangelogs
	dh_lintian
	dh_strip --dbg-package=libboost$(PKGVERSION)-dbg -X"-d-"
	dh_link
	dh_compress -Xlibboost$(PKGVERSION)-doc/HTML
	dh_pysupport
	dh_fixperms

	@if [ "$(DH_OPTIONS)" = "-a" ]; then \
		echo DH_OPTIONS=-plibboost$(PKGVERSION)-dbg dh_makeshlibs -V"libboost$(PKGVERSION)-dbg $(SHLIBS_VERSION)"; \
		DH_OPTIONS=-plibboost$(PKGVERSION)-dbg dh_makeshlibs -V"libboost$(PKGVERSION)-dbg $(SHLIBS_VERSION)"; \
		for name in $(boost_libs); do \
			lib=libboost-$${name}$(SOVERSION); \
			echo DH_OPTIONS=-p$${lib} dh_makeshlibs -V"$${lib} $(SHLIBS_VERSION)"; \
			DH_OPTIONS=-p$${lib} dh_makeshlibs -V"$${lib} $(SHLIBS_VERSION)"; \
		done; \
	fi

	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture independant packages using the common target.
binary-indep: build install
	$(MAKE) -f debian/rules DH_OPTIONS=-i binary-common

# Build architecture dependant packages using the common target.
binary-arch: build install
	$(MAKE) -f debian/rules DH_OPTIONS=-a binary-common

# Any other binary targets build just one binary package at a time.
binary-%: build install
	$(MAKE) -f debian/rules binary-common DH_OPTIONS=-p$*

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary-common binary install
